<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Ammo.js Raycast vehicle demo</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                color: #61443e;
                font-family:Monospace;
                font-size:13px;
                text-align:center;

                background-color: #bfd1e5;
                margin: 0px;
                overflow: hidden;
            }

			#latency {
				color: #ffffff;
				background-color: #990000;
				position: absolute;
				bottom: 0px;
				padding: 5px;
			}   

			#info {
                position: absolute;
                top: 0px; width: 100%;
                padding: 5px;
            }

            a {

                color: #a06851;
            }

        </style>
    </head>
    <body>
        <div id="container"><br /><br /><br /><br /><br />Loading...</div>
        <div id="info">Ammo.js Kinematic Testing; WASD: move 'local' cube; Q: toggle lerping on 'remote' cube</div>
        <div id="latency">Simulated latency: 0.0 m/s</div>

		<script src="../builds/ammo.js"></script>

        <script src="../js/three/three.min.js"></script>
        <script src="../js/three/OrbitControls.js"></script>
        <script src="../js/three/Detector.js"></script>
        <script src="../js/three/stats.min.js"></script>

        <script src="./LerpedVector3.js"></script>
		<script src="./SlerpedQuaternion.js"></script>

        <script>

		Ammo().then(function(Ammo) {

			// Detects webgl
			if ( ! Detector.webgl ) {
				Detector.addGetWebGLMessage();
				document.getElementById( 'container' ).innerHTML = "";
			}

			// - Global variables -
			var DISABLE_DEACTIVATION = 4;
			var TRANSFORM_AUX = new Ammo.btTransform();
			var ZERO_QUATERNION = new THREE.Quaternion(0, 0, 0, 1);

			// Graphics variables
			var container, stats, latency;
			var camera, controls, scene, renderer;
			var terrainMesh, texture;
			var clock = new THREE.Clock();
			var materialDynamic, materialStatic, materialInteractive;

			// Physics variables
			var collisionConfiguration;
			var dispatcher;
			var broadphase;
			var solver;
			var physicsWorld;

			var syncList = [];
			var time = 0;
			var objectTimePeriod = 3;
			var timeNextSpawn = time + objectTimePeriod;
			var maxNumObjects = 30;

			// Keybord actions
			var actions = {};
			var keysActions = {
				"KeyW":'forward',
				"KeyS":'back',
				"KeyA":'left',
				"KeyD":'right',
				"KeyQ":'toggle_lerp'
			};

			var lerpedVector3 = LerpedVector3();
			var slerpedQuaternion = SlerpedQuaternion();

			var remoteBox, localBox;

			// - Functions -

			function initGraphics() {

				container = document.getElementById( 'container' );
				latency = document.getElementById( 'latency' );

				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.2, 2000 );
				camera.position.x = -4.84;
				camera.position.y = 4.39;
				camera.position.z = -35.11;
				camera.lookAt( new THREE.Vector3( 0.33, -0.40, 0.85 ) );
				controls = new THREE.OrbitControls( camera );

				renderer = new THREE.WebGLRenderer({antialias:true});
				renderer.setClearColor( 0xbfd1e5 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				var ambientLight = new THREE.AmbientLight( 0x404040 );
				scene.add( ambientLight );

				var dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
				dirLight.position.set( 10, 10, 5 );
				scene.add( dirLight );

				materialDynamic = new THREE.MeshPhongMaterial( { color:0xfca400 } );
				materialStatic = new THREE.MeshPhongMaterial( { color:0x999999 } );
				materialInteractive=new THREE.MeshPhongMaterial( { color:0x990000 } );

				container.innerHTML = "";

				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				window.addEventListener( 'resize', onWindowResize, false );
				window.addEventListener( 'keydown', keydown);
				window.addEventListener( 'keyup', keyup);
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function initPhysics() {

				// Physics configuration
				collisionConfiguration = new Ammo.btDefaultCollisionConfiguration();
				dispatcher = new Ammo.btCollisionDispatcher( collisionConfiguration );
				broadphase = new Ammo.btDbvtBroadphase();
				solver = new Ammo.btSequentialImpulseConstraintSolver();
				physicsWorld = new Ammo.btDiscreteDynamicsWorld( dispatcher, broadphase, solver, collisionConfiguration );
				physicsWorld.setGravity( new Ammo.btVector3( 0, -9.82, 0 ) );
			}

			function tick() {
				requestAnimationFrame( tick );
				var dt = clock.getDelta();
				for (var i = 0; i < syncList.length; i++)
					syncList[i](dt);
				physicsWorld.stepSimulation( dt, 10 );
				controls.update( dt );
				renderer.render( scene, camera );
				time += dt;
				stats.update();
			}

			function keyup(e) {
				if(keysActions[e.code]) {
					actions[keysActions[e.code]] = false;
					e.preventDefault();
					e.stopPropagation();
					return false;
				}
			}
			function keydown(e) {
				if(keysActions[e.code]) {
					actions[keysActions[e.code]] = true;
					e.preventDefault();
					e.stopPropagation();
					return false;
				}
			}

			function createBox(pos, quat, w, l, h, mass, friction, syncFunction) {
				var material = mass > 0 ? materialDynamic : materialStatic;
				var shape = new THREE.BoxGeometry(w, l, h, 1, 1, 1);
				var geometry = new Ammo.btBoxShape(new Ammo.btVector3(w * 0.5, l * 0.5, h * 0.5));

				if(!mass) mass = 0;
				if(!friction) friction = 1;

				var mesh = new THREE.Mesh(shape, material);
				mesh.position.copy(pos);
				mesh.quaternion.copy(quat);
				scene.add( mesh );

				var transform = new Ammo.btTransform();
				transform.setIdentity();
				transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));
				transform.setRotation(new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w));
				var motionState = new Ammo.btDefaultMotionState(transform);

				var localInertia = new Ammo.btVector3(0, 0, 0);
				geometry.calculateLocalInertia(mass, localInertia);

				var rbInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, geometry, localInertia);
				var body = new Ammo.btRigidBody(rbInfo);

				body.setFriction(friction);

				physicsWorld.addRigidBody( body );

				if (mass > 0) {
					body.setActivationState(DISABLE_DEACTIVATION);
					// Sync physics and graphics
					function sync(dt) {
						syncFunction(body, mesh, dt);
					}

					syncList.push(sync);
				}

				return body;
			}
				
			function createObjects() {

				createBox(new THREE.Vector3(0, -0.5, 0), ZERO_QUATERNION, 75, 1, 75, 0, 2);

				var shouldLerp = true;
				var wasPressed = false;
				remoteBox = createBox(new THREE.Vector3(10,15,0), ZERO_QUATERNION, 5,5,5,1,1,
					function sync(body, mesh, dt) {

						if (actions.toggle_lerp && !wasPressed) {
							wasPressed = true;
							shouldLerp = !shouldLerp;
						} else if (!actions.toggle_lerp)
						{
							wasPressed = false;
						}

						var ms = body.getMotionState();

						if (ms) {
							ms.getWorldTransform(TRANSFORM_AUX);

							var p = TRANSFORM_AUX.getOrigin();
							var q = TRANSFORM_AUX.getRotation();

							if (body.getCollisionFlags() == 2 && lerpedVector3.isSet() && shouldLerp) {
								var targetVector3 = lerpedVector3.getCurrentTarget();
								var targetQuaternion = slerpedQuaternion.getCurrentTarget();
								mesh.position.set(targetVector3.x, targetVector3.y, targetVector3.z);
								mesh.quaternion.set(targetQuaternion.x, targetQuaternion.y, targetQuaternion.z, targetQuaternion.w);
							} else {
								mesh.position.set(p.x(), p.y(), p.z());
								mesh.quaternion.set(q.x(), q.y(), q.z(), q.w());
							}
							
						}
					}
				);

				var force = 1500;

				localbox = createBox(new THREE.Vector3(0,5,0), ZERO_QUATERNION, 5,5,5,100,1,
					function sync(body, mesh, dt) {

						var appliedForce = new Ammo.btVector3(0, 0, 0);

						if (actions.forward) {
							appliedForce = new Ammo.btVector3(0, 0, force);
						}
						if (actions.back) {
							appliedForce = new Ammo.btVector3(0, 0, -force);
						}
						if (actions.left) {
							appliedForce = new Ammo.btVector3(force, 0, 0);
						}
						if (actions.right) {
							appliedForce = new Ammo.btVector3(-force, 0, 0);
						}

						body.applyForce(appliedForce, new Ammo.btVector3(0, 0, 0));

						var ms = body.getMotionState();

						if (ms) {
							ms.getWorldTransform(TRANSFORM_AUX);

							var p = TRANSFORM_AUX.getOrigin();
							var q = TRANSFORM_AUX.getRotation();

							mesh.position.set(p.x(), p.y(), p.z());
							mesh.quaternion.set(q.x(), q.y(), q.z(), q.w());
							
						}
					}
				);

			}

			function start() {
				window.setTimeout(function() {
					physicsWorld.removeRigidBody(remoteBox);
					remoteBox.setMassProps(0, new Ammo.btVector3(0,0,0));
					remoteBox.setCollisionFlags(2);
					remoteBox.setActivationState(4);
					physicsWorld.addRigidBody(remoteBox);

					var updateFreq = 50 + Math.random() * 50;
					var t = 0;
					var lastTime = Date.now();
					var loop = function() {
						var ms = remoteBox.getMotionState();

						if (ms) {
							ms.getWorldTransform(TRANSFORM_AUX);

							var p = TRANSFORM_AUX.getOrigin();
							var q = TRANSFORM_AUX.getRotation();

							var dt = Date.now() - lastTime;
							var speed = 10000;
							t = dt % speed;
							var r = 10;
							var angle = THREE.Math.lerp(0, 2 * Math.PI, t/speed);
							var x = r * Math.cos(angle);
							var z = r * Math.sin(angle);

							lerpedVector3.setTarget(new THREE.Vector3(x, p.y(), z), updateFreq);
							var quaternion = new THREE.Quaternion(q.x(), q.y(), q.z(), q.w());
							quaternion.setFromAxisAngle(new THREE.Vector3(0,1,0), angle);
							slerpedQuaternion.setTarget(quaternion, updateFreq)
							var transform = new Ammo.btTransform();
							transform.setIdentity();
							transform.setOrigin(new Ammo.btVector3(x, p.y(), z));
							transform.setRotation(new Ammo.btQuaternion(quaternion.x, quaternion.y, quaternion.z, quaternion.w));
							ms.setWorldTransform(transform);
						}
						updateFreq = 50 + Math.random() * 50;

						latency.innerHTML = 'Simulated latency: ' + Math.round(updateFreq*100)/100 + ' ms';
						window.setTimeout(loop, updateFreq);
					};
					window.setTimeout(loop, updateFreq);
				}, 4000);
			}

			// - Init -
			initGraphics();
			initPhysics();
			createObjects();
			start();
			tick();

		});

        </script>
    </body>
</html>
